#!/usr/bin/env python3
"""
Andy's Happy Little Language Interpreter
Simple standalone version
"""

import sys
import os
import json
import subprocess
import re

class AHLLInterpreter:
    def __init__(self):
        self.variables = {}
        self.classrooms = {}
        self.functions = {}
        self.temp_answer = None
        
    def run(self, code, filename="<input>"):
        lines = code.strip().split('\n')
        i = 0
        
        while i < len(lines):
            line = lines[i].strip()
            
            # Skip comments
            if line.startswith('//') or not line:
                i += 1
                continue
                
            # Remove trailing comments
            if '//' in line:
                line = line.split('//')[0].strip()
                
            try:
                if not self.execute(line):
                    print(f"‚ùå Syntax error at line {i+1}: {line}", file=sys.stderr)
                    return False
            except Exception as e:
                print(f"‚ùå Error at line {i+1}: {e}", file=sys.stderr)
                return False
                
            i += 1
        return True
        
    def execute(self, line):
        # write_this
        if line.startswith('write_this('):
            expr = self.extract_content(line[11:], ')')
            result = self.eval_expr(expr)
            print(str(result), end='')
            return True
            
        # ask_this
        elif line.startswith('ask_this('):
            prompt = self.eval_expr(self.extract_content(line[9:], ')'))
            self.temp_answer = input(prompt)
            return True
            
        # create_new_classroom_named_
        elif line.startswith('create_new_classroom_named_('):
            name = self.eval_expr(self.extract_content(line[28:], ')'))
            self.classrooms[name] = []
            return True
            
        # add_new_student_with_name_of_..._to_happy_children_prison_LOL
        elif line.startswith('add_new_student_with_name_of_(') and '_to_happy_children_prison_LOL' in line:
            var_part = line[28:]
            var_name = self.eval_expr(self.extract_content(var_part, ')_to_happy_children_prison_LOL'))
            self.variables[var_name] = None
            return True
            
        # teach_..._a_bit_of_..._from_happy_children_prison
        elif line.startswith('teach_(') and '_from_happy_children_prison' in line:
            # Remove prefix and suffix
            inner = line[7:line.rfind(')_from_happy_children_prison')]
            var_name, value = inner.split(')_a_bit_of_(')
            var_name = self.eval_expr(var_name)
            value = self.eval_expr(value)
            self.variables[var_name] = value
            return True
            
        # nuke_list_
        elif line.startswith('nuke_list_('):
            list_name = self.eval_expr(self.extract_content(line[10:], ')'))
            if list_name in self.classrooms:
                del self.classrooms[list_name]
            return True
            
        # If_ condition
        elif line.startswith('If_') and '_then_do:' in line:
            # This is a simplified version - real interpreter would handle blocks
            cond = line[3:line.find('_then_do:')]
            if self.eval_cond(cond):
                # Execute indented block
                pass
            return True
            
        # Math operations
        elif ' = [' in line and ']' in line:
            var_name, expr = line.split(' = [')
            var_name = var_name.strip()
            expr = expr.rstrip(']')
            result = self.do_math(expr)
            self.variables[var_name] = result
            return True
            
        # Simple assignment
        elif ' = ' in line:
            var_name, value = line.split(' = ', 1)
            var_name = var_name.strip()
            value = self.eval_expr(value.strip())
            self.variables[var_name] = value
            return True
            
        return False
        
    def eval_expr(self, expr):
        expr = expr.strip()
        
        # String literal
        if expr.startswith('"') and expr.endswith('"'):
            return expr[1:-1]
            
        # Variable
        if expr in self.variables:
            return self.variables[expr]
            
        # Math expression
        if expr.startswith('[') and expr.endswith(']'):
            return self.do_math(expr[1:-1])
            
        # Try as number
        try:
            if '.' in expr:
                return float(expr)
            return int(expr)
        except:
            return expr
            
    def do_math(self, expr):
        # Replace variables with values
        for var, val in self.variables.items():
            if val is not None and str(var) in expr:
                expr = expr.replace(str(var), str(val))
                
        # Safe eval
        allowed_chars = set('0123456789+-*/(). ')
        if all(c in allowed_chars for c in expr):
            return eval(expr)
        return 0
        
    def eval_cond(self, cond):
        # Simple equality check
        if '_is_(' in cond:
            left, right = cond.split('_is_(')
            left = self.eval_expr(left[1:])  # Remove leading '('
            right = self.eval_expr(right[:-1])  # Remove trailing ')'
            return left == right
        return False
        
    def extract_content(self, text, end_char):
        """Extract content between first ( and matching end_char"""
        count = 1
        result = []
        
        for char in text:
            if char == '(':
                count += 1
            elif char == ')':
                count -= 1
                
            if count == 0:
                break
                
            result.append(char)
            
        return ''.join(result)
        
def main():
    if len(sys.argv) < 2:
        # REPL mode
        print("üåª AHLL v1.0 - Type 'exit' to quit")
        interpreter = AHLLInterpreter()
        
        while True:
            try:
                line = input("üåª> ")
                if line.lower() in ('exit', 'quit'):
                    break
                interpreter.execute(line)
            except KeyboardInterrupt:
                print("\nüëã Goodbye!")
                break
    else:
        # Execute file
        filename = sys.argv[1]
        if not filename.endswith('.ahll'):
            print("‚ùå Error: File must have .ahll extension", file=sys.stderr)
            sys.exit(1)
            
        try:
            with open(filename, 'r') as f:
                code = f.read()
                
            interpreter = AHLLInterpreter()
            if interpreter.run(code, filename):
                print("\n‚úÖ Program completed successfully!")
            else:
                sys.exit(1)
                
        except FileNotFoundError:
            print(f"‚ùå Error: File '{filename}' not found", file=sys.stderr)
            sys.exit(1)
        except Exception as e:
            print(f"‚ùå Error: {e}", file=sys.stderr)
            sys.exit(1)
            
if __name__ == '__main__':
    main()